# Maintainer: Originull Software <packages@originull.org>
pkgname=brotli
pkgver=1.1.0
pkgrel=0
pkgdesc="Generic lossless compressor"
url="https://github.com/google/brotli"
arch="all"
license="MIT"
makedepends_build="automake autoconf libtool"
if [ -z "$BOOTSTRAP" ]; then
	makedepends_host="python3-dev"
	python="py3-$pkgname:py3"
fi
subpackages="$pkgname-doc $pkgname-static $pkgname-dev $pkgname-libs $python"
source="$pkgname-$pkgver.tar.gz::https://github.com/google/brotli/archive/refs/tags/v$pkgver.tar.gz
	"

# secfixes:
#   1.0.9-r0:
#     - CVE-2020-8927

# use sysroot when cross compiling to avoid libtool pulling in host libs
[ "$CBUILD"  != "$CHOST" ] && _cross_configure="--with-sysroot=$CBUILDROOT"

prepare() {
	default_prepare
	sed -i 's,/usr/bin/env bash,/bin/sh,' tests/*.sh
	sh ./bootstrap
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--target=$CTARGET \
		--prefix=/usr \
		$_cross_configure \
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install

	local man; for man in docs/*.?; do
		install -D -m644 $man "$pkgdir"/usr/share/man/man${man##*.}/${man##*/}
	done
}

py3() {
	cd "$builddir"
	python3 setup.py install --prefix=/usr --root="$subpkgdir"
}

sha512sums="6eb280d10d8e1b43d22d00fa535435923c22ce8448709419d676ff47d4a644102ea04f488fc65a179c6c09fee12380992e9335bad8dfebd5d1f20908d10849d9  brotli-1.1.0.tar.gz
"
