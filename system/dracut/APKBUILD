# Contributor: Originull Software <packages@originull.org>
# Maintainer: Originull Software <packages@originull.org>
pkgname=dracut
pkgver=059
pkgrel=1
pkgdesc="Event-driven initramfs infrastructure"
url="https://dracut.wiki.kernel.org/"
arch="all"
options="!check"  # Test suite is for kernel developers only, requires ext3 rootfs
license="GPL-2.0+"
depends="bash gzip libarchive-tools xz"
makedepends="kmod-dev asciidoc"
triggers="$pkgname.trigger=/usr/share/kernel/*"
subpackages="$pkgname-doc $pkgname-bash-completion:bashcomp:noarch
	$pkgname-crypt::noarch $pkgname-lvm::noarch"
provides="initramfs-generator"
source="$pkgname-$pkgver.tar.gz::https://github.com/dracutdevs/$pkgname/archive/refs/tags/$pkgver.tar.gz
	dracut.conf
	"

build() {
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--systemdsystemunitdir=/usr/lib/systemd/system \
		--localstatedir=/var
	make
	make doc
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install
	mkdir -p "$pkgdir"/etc/dracut.conf.d/
	cp "$srcdir"/dracut.conf "$pkgdir"/etc/dracut.conf.d/hollywood.conf
	rm -r "$pkgdir"/usr/lib/dracut/modules.d/01systemd-networkd

}

bashcomp() {
	depends="dracut"
	pkgdesc="Bash completions for $pkgname"
	install_if="$pkgname=$pkgver-r$pkgrel bash-completion"

	mkdir -p "$subpkgdir"/usr/share/
	mv "$pkgdir"/usr/share/bash-completion \
		"$subpkgdir"/usr/share
}

crypt() {
	depends="cryptsetup dracut lvm2"
	pkgdesc="$pkgname - LUKS / disk encryption support (crypt) module"
	mkdir -p "$subpkgdir"
}

lvm() {
	depends="dracut lvm2"
	pkgdesc="$pkgname - LVM2 module"
	mkdir -p "$subpkgdir"
}

sha512sums="
196bc8bf18703c72bffb51a7e0493719c58173ad2da7d121eb42f9a8de47e953af36d109214dc4a10b2dc2d3bd19e844f7f51c2bdec087e064ea11f75124032d  dracut-059.tar.gz
ee0902873afb791919f8bf7161e3f0a465f1098b56845d797758b7b7bd3520c3d55ff45ef9243fa855ff8d1a287fe69ebcaadf3c3ee2045ea5715e54459332a0  dracut.conf
"
