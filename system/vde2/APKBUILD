# Maintainer: Originull Software <packages@originull.org>
pkgname=vde2
pkgver=2.3.3
pkgrel=0
pkgdesc="VDE: Virtual Distributed Ethernet. User mode networking for QEMU, UML, etc."
url="http://vde.sf.net"
arch="all"
options="!check"  # No test suite.
license="GPL"
depends="openssl"
install="vde2.pre-install"
makedepends="linux-headers openssl-dev libpcap-dev python3-dev"
subpackages="$pkgname-doc $pkgname-dev $pkgname-libs"
source="$pkgname-$pkgver.tar.gz::https://github.com/virtualsquare/vde-2/archive/refs/tags/v$pkgver.tar.gz
	vde2.pre-up
	vde2.post-down
	"

builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	cd "$builddir"
	default_prepare

	update_config_sub
}

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc
	make -C src/common
	make -j1 -C src/lib
	make
}

package() {
	cd "$builddir"
	make -j1 DESTDIR="$pkgdir" install

	install -Dm755 "$srcdir"/vde2.pre-up \
		"$pkgdir"/etc/network/if-pre-up.d/vde2
	install -Dm755 "$srcdir"/vde2.post-down \
		"$pkgdir"/etc/network/if-post-down.d/vde2
}

libs() {
	pkgdesc="Virtual Distributed Ethernet libraries"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/lib*.so.* "$subpkgdir"/usr/lib/
}

sha512sums="d0495aa700984dcc82f85cf7c8125cc10505a8a077fceec45b7fd2bec9c389966381682842e886469fa49239badd9442403d091c2ae5282685085e8262396387  vde2-2.3.3.tar.gz
71b29d538bba80b881f239d683215279089c14e8feec05bf27c159ead51094cdfb168281900fa4527f588c624e8f7687df8d3f79377e07d13ad64de613177df3  vde2.pre-up
d1cf18146145dbe608842c694b05d2906e36553b0ba3fa1ec2e53dbf06027b9e4937ea61aee77c1ccbb73b818f19d55787051eb6d5b09a38c7d18a1dad629190  vde2.post-down"
